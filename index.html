import React, { useEffect, useMemo, useState } from "react";

const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

const ElectroscopeSim = () => {
  // 0 = touching, 100 = far away
  const [wandPosition, setWandPosition] = useState(100);
  const [wandPolarity, setWandPolarity] = useState("negative"); // 'positive' | 'negative'
  const [storedCharge, setStoredCharge] = useState(0); // -100..100
  const [showHelp, setShowHelp] = useState(true);
  const [showLabels, setShowLabels] = useState(false);

  // Visual / model constants
  const MAX_LEAF_ANGLE = 45; // degrees
  const TOUCH_THRESHOLD = 2; // slider units
  const MAX_TRANSFERABLE = 80; // max |charge| via conduction
  const STEP_PER_TICK = 5; // how fast charge changes when touching
  const TICK_MS = 50;

  // Optional: tiny leakage back to neutral when not touching
  const ENABLE_LEAK = false;
  const LEAK_STEP = 1;

  const isTouching = wandPosition <= TOUCH_THRESHOLD;

  // Wand X mapping inside SVG
  const wandSvgX = useMemo(() => 230 + wandPosition * 2.2, [wandPosition]);

  // Run a small "physics" tick
  useEffect(() => {
    const id = setInterval(() => {
      setStoredCharge((prev) => {
        let next = prev;

        if (isTouching) {
          const target = wandPolarity === "positive" ? MAX_TRANSFERABLE : -MAX_TRANSFERABLE;
          if (next < target) next = Math.min(next + STEP_PER_TICK, target);
          if (next > target) next = Math.max(next - STEP_PER_TICK, target);
        } else if (ENABLE_LEAK) {
          if (next > 0) next = Math.max(0, next - LEAK_STEP);
          if (next < 0) next = Math.min(0, next + LEAK_STEP);
        }

        return next === prev ? prev : next;
      });
    }, TICK_MS);

    return () => clearInterval(id);
  }, [isTouching, wandPolarity]);

  // Induction: stronger when closer, weaker when far
  const inductionStrength = useMemo(() => {
    const closeness = clamp((100 - wandPosition) / 100, 0, 1);
    return closeness; // 0..1
  }, [wandPosition]);

  // Angle calculation: stored charge dominates, induction adds a small extra spread
  const leafAngle = useMemo(() => {
    const chargeAngle = (Math.abs(storedCharge) / 100) * MAX_LEAF_ANGLE;

    // Induction angle is modest; if already charged, it nudges a bit rather than overriding.
    const inductionAngle = inductionStrength * 12; // tweakable

    const combined = chargeAngle + (storedCharge === 0 ? inductionAngle * 0.7 : inductionAngle * 0.25);
    return clamp(combined, 0, MAX_LEAF_ANGLE);
  }, [storedCharge, inductionStrength]);

  const handleGround = () => {
    setStoredCharge(0);
  };

  const Label = ({ x, y, text, align = "left" }) => (
    <g style={{ pointerEvents: "none" }}>
      <circle cx={x} cy={y} r="3" fill="#3b82f6" />
      <line
        x1={x}
        y1={y}
        x2={align === "left" ? x - 40 : x + 40}
        y2={y}
        stroke="#3b82f6"
        strokeWidth="1"
      />
      <text
        x={align === "left" ? x - 45 : x + 45}
        y={y + 4}
        textAnchor={align === "left" ? "end" : "start"}
        fontSize="14"
        fill="#1e293b"
        fontWeight="600"
      >
        {text}
      </text>
    </g>
  );

  const chargeSymbol = storedCharge > 0 ? "+" : "−";
  const chargeColor = storedCharge > 0 ? "#dc2626" : "#2563eb";

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-4 font-sans text-slate-800 relative">
      {showHelp && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 border border-slate-200">
            <h2 className="text-2xl font-bold text-slate-800 mb-4 flex items-center gap-2">
              <span className="bg-indigo-100 text-indigo-600 p-2 rounded-lg">⚡</span>
              How to Use
            </h2>
            <div className="space-y-4 text-slate-600 mb-8">
              <div className="flex gap-3">
                <div className="font-bold text-slate-400">1</div>
                <p>
                  Select the <strong>Wand Charge Type</strong> (Positive or Negative).
                </p>
              </div>
              <div className="flex gap-3">
                <div className="font-bold text-slate-400">2</div>
                <p>
                  Drag the <strong>Position Control</strong> slider left to move the wand closer.
                </p>
              </div>
              <div className="flex gap-3">
                <div className="font-bold text-slate-400">3</div>
                <p>
                  Touch the sphere to transfer charge. The gold leaves <strong>repel</strong> because like charges repel.
                </p>
              </div>
              <div className="flex gap-3">
                <div className="font-bold text-slate-400">4</div>
                <p>
                  Click <strong>Ground (Reset)</strong> to discharge the electroscope.
                </p>
              </div>
            </div>
            <button
              onClick={() => setShowHelp(false)}
              className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition-colors shadow-lg shadow-indigo-200"
            >
              Continue
            </button>
          </div>
        </div>
      )}

      <div className="max-w-3xl w-full mb-6 text-center">
        <h1 className="text-3xl font-bold text-slate-900 mb-2">Electroscope Simulator</h1>
        <p className="text-slate-600 leading-relaxed">
          An electroscope detects electric charge. When a charged object touches the metal sphere, charge spreads
          down the rod to the gold leaves. Since like charges repel, the leaves push apart.
        </p>
      </div>

      <div className="flex flex-col lg:flex-row gap-8 items-start max-w-5xl w-full">
        <div className="relative w-full lg:w-2/3 h-[500px] bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden flex justify-center items-end pb-10">
          <div
            className="absolute inset-0 opacity-5 pointer-events-none"
            style={{
              backgroundImage: "radial-gradient(#000 1px, transparent 1px)",
              backgroundSize: "20px 20px",
            }}
          />

          <svg viewBox="0 0 400 500" className="w-full h-full max-w-[400px]">
            {/* Glass Jar */}
            <path
              d="M 120 180 L 120 450 Q 120 480 200 480 Q 280 480 280 450 L 280 180 Z"
              fill="rgba(220, 240, 255, 0.3)"
              stroke="#94a3b8"
              strokeWidth="2"
            />
            <ellipse
              cx="200"
              cy="180"
              rx="80"
              ry="20"
              fill="rgba(200, 230, 255, 0.4)"
              stroke="#94a3b8"
              strokeWidth="2"
            />

            {/* Stopper */}
            <rect x="180" y="160" width="40" height="40" fill="#475569" rx="2" />

            {/* Rod */}
            <rect x="195" y="100" width="10" height="200" fill="#cbd5e1" stroke="#64748b" />

            {/* Leaves */}
            <g transform="translate(200, 300)">
              <g transform={`rotate(-${leafAngle})`}>
                <rect x="-2" y="0" width="4" height="100" fill="#fbbf24" stroke="#d97706" rx="2" />
                {Math.abs(storedCharge) > 10 && (
                  <text x="-15" y="60" fontSize="20" fill={chargeColor} fontWeight="bold">
                    {chargeSymbol}
                  </text>
                )}
              </g>
              <g transform={`rotate(${leafAngle})`}>
                <rect x="-2" y="0" width="4" height="100" fill="#fbbf24" stroke="#d97706" rx="2" />
                {Math.abs(storedCharge) > 10 && (
                  <text x="5" y="60" fontSize="20" fill={chargeColor} fontWeight="bold">
                    {chargeSymbol}
                  </text>
                )}
              </g>
            </g>

            {/* Sphere */}
            <defs>
              <radialGradient id="sphereGradient" cx="30%" cy="30%">
                <stop offset="0%" stopColor="#f1f5f9" />
                <stop offset="100%" stopColor="#64748b" />
              </radialGradient>
            </defs>
            <circle cx="200" cy="80" r="30" fill="url(#sphereGradient)" stroke="#94a3b8" />

            {Math.abs(storedCharge) > 5 && (
              <text x="188" y="90" fontSize="24" fill={chargeColor} fontWeight="bold">
                {chargeSymbol}
              </text>
            )}

            {/* Wand */}
            <g transform={`translate(${wandSvgX}, 60)`}>
              <rect
                x="0"
                y="0"
                width="200"
                height="40"
                rx="20"
                fill={wandPolarity === "positive" ? "#fee2e2" : "#dbeafe"}
                stroke={wandPolarity === "positive" ? "#fca5a5" : "#93c5fd"}
                strokeWidth="2"
              />
              <path
                d="M 0 0 L 40 0 L 40 40 L 0 40 A 20 20 0 0 1 0 0"
                fill={wandPolarity === "positive" ? "#ef4444" : "#3b82f6"}
              />
              <text x="8" y="26" fontSize="20" fill="white" fontWeight="bold">
                {wandPolarity === "positive" ? "+" : "−"}
              </text>
              <text x="22" y="26" fontSize="20" fill="white" fontWeight="bold">
                {wandPolarity === "positive" ? "+" : "−"}
              </text>

              {isTouching && <circle cx="0" cy="20" r="15" fill="yellow" opacity="0.6" />}
            </g>

            {/* Labels */}
            {showLabels && (
              <g>
                <Label x={168} y={70} text="Metal Sphere" align="left" />
                <Label x={282} y={350} text="Glass Jar" align="right" />
                <Label x={200} y={380} text="Gold Leaves" align="right" />
              </g>
            )}
          </svg>
        </div>

        {/* Controls */}
        <div className="w-full lg:w-1/3 flex flex-col gap-6">
          <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
            <div className="flex justify-between items-center mb-4">
              <h2 className="font-bold text-lg flex items-center gap-2">
                <span className="w-2 h-6 bg-slate-800 rounded-sm"></span> Controls
              </h2>
              <button
                onClick={() => setShowHelp(true)}
                className="text-xs font-bold text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 px-3 py-1 rounded-full transition-colors"
              >
                ? Instructions
              </button>
            </div>

            <div className="mb-6 flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-100">
              <span className="text-sm font-semibold text-slate-700">Show Component Labels</span>
              <button
                onClick={() => setShowLabels((v) => !v)}
                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                  showLabels ? "bg-indigo-600" : "bg-slate-300"
                }`}
                aria-label="Toggle component labels"
              >
                <span
                  className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                    showLabels ? "translate-x-6" : "translate-x-1"
                  }`}
                />
              </button>
            </div>

            <div className="mb-6">
              <div className="flex justify-between mb-2">
                <label className="font-semibold text-sm text-slate-600">Position Control</label>
                <span
                  className={`text-xs font-mono px-2 py-1 rounded transition-colors ${
                    isTouching ? "bg-green-100 text-green-700 font-bold" : "bg-slate-100"
                  }`}
                >
                  {isTouching ? "TOUCHING" : "DISTANCE: " + wandPosition}
                </span>
              </div>
              <input
                type="range"
                min="0"
                max="100"
                value={wandPosition}
                onChange={(e) => setWandPosition(Number(e.target.value))}
                className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                aria-label="Wand distance slider"
              />
              <p className="text-xs text-slate-400 mt-2">Drag slider to 0 to touch the sphere.</p>
            </div>

            <div className="mb-6">
              <label className="font-semibold text-sm text-slate-600 block mb-2">Wand Charge Type</label>
              <div className="flex bg-slate-100 p-1 rounded-lg">
                <button
                  onClick={() => setWandPolarity("negative")}
                  className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${
                    wandPolarity === "negative"
                      ? "bg-white shadow text-blue-600"
                      : "text-slate-500 hover:text-slate-700"
                  }`}
                >
                  Negative (−)
                </button>
                <button
                  onClick={() => setWandPolarity("positive")}
                  className={`flex-1 py-2 rounded-md text-sm font-medium transition-colors ${
                    wandPolarity === "positive"
                      ? "bg-white shadow text-red-600"
                      : "text-slate-500 hover:text-slate-700"
                  }`}
                >
                  Positive (+)
                </button>
              </div>
            </div>

            <button
              onClick={handleGround}
              className="w-full py-3 bg-slate-800 text-white rounded-lg font-semibold hover:bg-slate-700 transition-colors"
            >
              Ground (Reset)
            </button>
          </div>

          <div className="bg-blue-50 p-6 rounded-xl border border-blue-100">
            <h3 className="font-bold text-blue-900 mb-2">Current State</h3>
            <ul className="space-y-2 text-sm text-blue-800">
              <li className="flex items-start gap-2">
                <span className="mt-1 block min-w-[8px] min-h-[8px] rounded-full bg-blue-400"></span>
                <span>
                  <strong>Charge Level:</strong> {Math.abs(storedCharge) < 5 ? "Neutral" : "Charged"}
                </span>
              </li>
              <li className="flex items-start gap-2">
                <span className="mt-1 block min-w-[8px] min-h-[8px] rounded-full bg-blue-400"></span>
                <span>
                  <strong>Leaf Position:</strong> {leafAngle < 2 ? "Vertical (Relaxed)" : "Separated (Repelling)"}
                </span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ElectroscopeSim;
