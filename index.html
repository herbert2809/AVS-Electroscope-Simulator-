import React, { useState, useEffect } from 'react';

// Helper for drawing label lines - Moved outside main component for performance
const Label = ({ x, y, text, align = 'left' }) => (
  <g className="animate-in fade-in duration-500 pointer-events-none">
    <circle cx={x} cy={y} r="3" fill="#3b82f6" />
    <line 
      x1={x} y1={y} 
      x2={align === 'left' ? x - 40 : x + 40} 
      y2={y} 
      stroke="#3b82f6" 
      strokeWidth="1" 
    />
    <text 
      x={align === 'left' ? x - 45 : x + 45} 
      y={y + 4} 
      textAnchor={align === 'left' ? 'end' : 'start'} 
      fontSize="14" 
      fill="#1e293b" 
      fontWeight="600"
      className="uppercase tracking-wide"
    >
      {text}
    </text>
  </g>
);

const ElectroscopeSim = () => {
  // State for the simulation
  const [wandPosition, setWandPosition] = useState(100); // 0 = touching, 100 = far away
  const [wandPolarity, setWandPolarity] = useState('negative'); // 'positive' or 'negative'
  const [electroscopeCharge, setElectroscopeCharge] = useState(0); // -100 to 100
  const [isTouching, setIsTouching] = useState(false);
  const [showHelp, setShowHelp] = useState(true); // Default to showing instructions
  const [showLabels, setShowLabels] = useState(false); // Toggle for component labels
  
  // Constants for visuals
  const MAX_LEAF_ANGLE = 45; // degrees
  // Threshold logic: 0 on slider means touching. 
  // We will map slider 0-100 to SVG coordinates.
  const TOUCH_THRESHOLD = 2; 

  // Physics Logic Loop
  useEffect(() => {
    let targetCharge = electroscopeCharge;
    const isNowTouching = wandPosition <= TOUCH_THRESHOLD;
    setIsTouching(isNowTouching);

    // 1. Conduction (Touching)
    if (isNowTouching) {
      // Charge flows from wand to electroscope
      const chargeMagnitude = 80; // Max charge transferable
      
      // Gradually increase charge to match wand
      if (wandPolarity === 'positive' && electroscopeCharge < chargeMagnitude) {
        targetCharge = Math.min(electroscopeCharge + 5, chargeMagnitude);
      } else if (wandPolarity === 'negative' && electroscopeCharge > -chargeMagnitude) {
        targetCharge = Math.max(electroscopeCharge - 5, -chargeMagnitude);
      }
    }

    // Update state if changed
    if (targetCharge !== electroscopeCharge) {
      setElectroscopeCharge(targetCharge);
    }
  }, [wandPosition, wandPolarity, electroscopeCharge]);

  // Calculate leaf angle based on absolute charge magnitude
  const inductionEffect = (100 - wandPosition) / 100 * 20; 
  const permanentAngle = (Math.abs(electroscopeCharge) / 100) * MAX_LEAF_ANGLE;
  
  let currentAngle = permanentAngle;
  if (electroscopeCharge === 0 && wandPosition < 60) {
     currentAngle = inductionEffect * 0.5; 
  }

  const handleReset = () => {
    setElectroscopeCharge(0);
  };

  // Wand SVG calculation
  // Sphere Center X = 200, Radius = 30. Right Edge = 230.
  // Wand Tip X needs to be at 230 when position is 0.
  // We'll move the wand from X=230 (touching) to X=450 (far).
  const wandSvgX = 230 + (wandPosition * 2.2); 

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-4 font-sans text-slate-800 relative">
      
      {/* --- INSTRUCTION MODAL OVERLAY --- */}
      {showHelp && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 border border-slate-200 animate-in fade-in zoom-in duration-300">
